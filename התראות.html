<!DOCTYPE html>
<html lang="he">
<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>40 ימי תפילה - כל המתפלל על חברו נענה תחילה</title>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-messaging-compat.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&family=Amatic+SC:wght@700&display=swap" rel="stylesheet">
<style>
/* הקוד CSS הקיים נשאר ללא שינוי */
</style>
</head>
<body>
<div class="container fade-in">
    <h1>כל המתפלל על חברו נענה תחילה</h1>
    <label for="name">בחר את שמך:</label>
    <select id="name"></select>
    <p id="prayerRequest" class="slide-in"></p>
    <p id="dayCount" class="slide-in">יום 1 מתוך 40</p>
    <div id="dateDisplay">
        <p>תאריך עברי: <span id="hebrewDate"></span></p>
        <p>תאריך לועזי: <span id="gregorianDate"></span></p>
    </div>
    <label class="checkbox-wrapper">סמן אם כבר אמרת את הפרק
        <input type="checkbox" id="prayerDone">
        <span class="checkmark"></span>
    </label>
    <button id="submit">שמור</button>
    <button id="requestNotifications">אשר קבלת התראות</button>
    <div id="prayerText" class="slide-in"></div>
    <div id="allPrayers" class="slide-in">
        <h3>כל בקשות התפילה:</h3>
        <ul id="prayerList"></ul>
    </div>
    <div id="prayerStatus" class="slide-in">
        <h3>סטטוס תפילה:</h3>
        <ul id="prayerStatusList"></ul>
    </div>
    <div id="prayerStats" class="slide-in">
        <p>ימים שעברו: <span id="daysPassed"></span></p>
        <p>ימים שנותרו: <span id="daysLeft"></span></p>
        <p>אחוז השלמה: <span id="completionPercentage"></span></p>
        <p>מספר אנשים: <span id="totalPeople"></span></p>
    </div>
</div>
<button id="adminBtn">ניהול</button>
<div id="adminSection" style="display:none;">
    <h2>ניהול</h2>
    <label for="startDate">בחר תאריך התחלה:</label>
    <input type="date" id="startDate">
    <button id="setStartDate">קבע תאריך התחלה</button>
    <label for="newName">הוסף שם לתפילה:</label>
    <input type="text" id="newName">
    <label for="newPrayer">הוסף בקשת תפילה:</label>
    <input type="text" id="newPrayer">
    <label for="newEmoji">הוסף אימוג'י:</label>
    <input type="text" id="newEmoji">
    <button id="addName">הוסף</button>
    <label for="setCurrentDay">הגדר את היום הנוכחי (1-40):</label>
    <input type="number" id="setCurrentDay" min="1" max="40">
    <button id="updateCurrentDay">עדכן</button>
</div>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyDwJfwmRD5ev12tCLFAPn07xdA8aYKWjsM",
    authDomain: "everyone-who-prays-for.firebaseapp.com",
    databaseURL: "https://everyone-who-prays-for-default-rtdb.firebaseio.com",
    projectId: "everyone-who-prays-for",
    storageBucket: "everyone-who-prays-for.appspot.com",
    messagingSenderId: "60325762396",
    appId: "1:60325762396:web:d0406af3dc9f321dea9d99",
    measurementId: "G-K74ST2R3XW"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const messaging = firebase.messaging();

let users = [
    {name: "הלל בן חמדה", prayer: "הצלחה בלימודים", emoji: "📚"},
    {name: "נתנאל איתמר בן מירה", prayer: "זיווג טוב ומתאים", emoji: "💍"},
    {name: "נחום זאב בן מרים", prayer: "הצלחה בלימודים", emoji: "📚"},
    {name: "אריאל בן סיגלית", prayer: "זיווג טוב ומתאים", emoji: "💍"},
    {name: "שי בן שירה", prayer: "זיווג טוב ומתאים", emoji: "💍"},
    {name: "משה בן רֵנָה", prayer: "להתפלל במניין נץ בקביעות", emoji: "🌅"},
    {name: "רונן בן מירה", prayer: "פרנסה בשפע בקלות ובשמחה", emoji: "💵"},
    {name: "נועם יששכר בן שולמית", prayer: "זיווג טוב ומתאים", emoji: "💍"},
    {name: "חגי שמעון בן שרית", prayer: "בריאות איתנה", emoji: "💪"},
    {name: "מנחם בן אסתר", prayer: "ס\"ד קניית דירה", emoji: "🏠"},
    {name: "איתמר בן נורית", prayer: "הצלחה בכל", emoji: "🎓"},
    {name: "דוד בנים בן יעל עקא", prayer: "רפואה שלימה ובריאות", emoji: "❤️‍🩹"}
];

const nameSelect = document.getElementById('name');
const prayerRequest = document.getElementById('prayerRequest');

users.forEach(user => {
    let option = document.createElement('option');
    option.value = user.name;
    option.text = user.name; 
    nameSelect.add(option);
});

nameSelect.addEventListener('change', () => {
    const selectedUser = users.find(user => user.name === nameSelect.value);
    if (selectedUser) {
        prayerRequest.textContent = `בקשת תפילה: ${selectedUser.prayer} ${selectedUser.emoji}`;
        prayerRequest.classList.remove('slide-in');
        void prayerRequest.offsetWidth;
        prayerRequest.classList.add('slide-in');
        localStorage.setItem('selectedName', nameSelect.value);
    }
});

window.addEventListener('load', () => {
    const savedName = localStorage.getItem('selectedName');
    if (savedName) {
        nameSelect.value = savedName;
        nameSelect.dispatchEvent(new Event('change'));
    }
    updateDayCount();
    updateDates();
});

document.getElementById('submit').addEventListener('click', () => {
    const selectedName = nameSelect.value;
    const day = currentDay;
    const prayerDone = document.getElementById('prayerDone').checked;

    db.ref('prayers/' + selectedName + '/day' + day).set({
        prayerDone: prayerDone,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
        alert('הנתונים נשמרו בהצלחה!');
        updatePrayerStatus();
    }).catch((error) => {
        console.error('שגיאה בכתיבה למסד הנתונים: ', error);
    });
});

document.getElementById('adminBtn').addEventListener('click', () => {
    const adminPassword = prompt("הכנס סיסמת מנהל");
    if (adminPassword === "זאבי") {
        document.getElementById('adminSection').style.display = 'block';
    } else {
        alert("סיסמה שגויה");
    }
});

document.getElementById('addName').addEventListener('click', () => {
    const newName = document.getElementById('newName').value;
    const newPrayer = document.getElementById('newPrayer').value;
    const newEmoji = document.getElementById('newEmoji').value;

    if (newName && newPrayer && newEmoji) {
        users.push({
            name: newName,
            prayer: newPrayer,
            emoji: newEmoji
        });

        let option = document.createElement('option');
        option.value = newName;
        option.text = newName; 
        nameSelect.add(option);

        alert('שם, בקשה ואימוג\'י נוספו בהצלחה!');
        displayAllPrayers();
    } else {
        alert('נא למלא את כל השדות');
    }
});

const prayerText = `מִזְמוֹר לְתוֹדָה: הָרִיעוּ לַיהוָה כָּל הָאָרֶץ.
עִבְדוּ אֶת יְהוָה בְּשִׂمְחָה בֹּאוּ לְפָנָיו בִּרְנָנָה.
דְּעוּ כִּי יְהוָה הוּא אֱלֹהִים הוּא עָשָׂנוּ וְלוֹ אֲנַחְנוּ עַמּוֹ וְצֹאן מַרְעִיתוֹ.
בֹּאוּ שְׁעָרָיו בְּתוֹדָה חֲצֵרֹתָיו בִּתְהִלָּה הוֹדוּ לוֹ בָּרֲכוּ שְׁמוֹ.
כִּי טוֹב יְהוָה לְעוֹלָם חַסְדּוֹ וְעַד דֹּר וָדֹר אֱמוּנָתוֹ.`;

document.getElementById('prayerText').textContent = prayerText;

function updatePrayerStatus() {
    const statusList = document.getElementById('prayerStatusList');
    statusList.innerHTML = '';

    users.forEach(user => {
        db.ref('prayers/' + user.name + '/day' + currentDay).once('value').then((snapshot) => {
            const li = document.createElement('li');
            const prayerDone = snapshot.val() && snapshot.val().prayerDone;
            li.textContent = `${user.name} ${user.emoji}: ${prayerDone ? 'התפלל' : 'טרם התפלל'}`;
            li.className = prayerDone ? 'prayed' : 'not-prayed';
            statusList.appendChild(li);
        });
    });
}

function displayAllPrayers() {
    const prayerList = document.getElementById('prayerList');
    prayerList.innerHTML = '';
    users.forEach(user => {
        const li = document.createElement('li');
        li.className = 'prayer-item';
        li.innerHTML = `<strong>${user.name}</strong>: ${user.prayer}`;
        prayerList.appendChild(li);
    });
}

let currentDay = 1;

function updateDayCount() {
    db.ref('prayerStartDate').once('value').then((snapshot) => {
        const startDate = new Date(snapshot.val());
        const today = new Date();
        const daysPassed = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
        currentDay = Math.min(Math.max(daysPassed, 1), 40);
        document.getElementById('dayCount').textContent = `יום ${currentDay} מתוך 40`;
        updatePrayerStats();
    });
}

document.getElementById('setStartDate').addEventListener('click', setStartDate);

function setStartDate() {
    const startDate = document.getElementById('startDate').value;
    if (startDate) {
        db.ref('prayerStartDate').set(startDate).then(() => {
            updateDayCount();
            alert('תאריך ההתחלה נקבע בהצלחה!');
        }).catch((error) => {
            console.error('שגיאה בשמירת תאריך ההתחלה: ', error);
        });
    } else {
        alert('אנא בחר תאריך תחילה');
    }
}

document.getElementById('updateCurrentDay').addEventListener('click', () => {
    const newDay = document.getElementById('setCurrentDay').value;
    if (newDay && newDay >= 1 && newDay <= 40) {
        db.ref('currentDay').set(parseInt(newDay)).then(() => {
            currentDay = parseInt(newDay);
            updateDayCount();
            alert('היום הנוכחי עודכן בהצלחה!');
        }).catch((error) => {
            console.error('שגיאה בעדכון היום הנוכחי: ', error);
        });
    } else {
        alert('אנא הכנס מספר תקין בין 1 ל-40');
    }
});

function updatePrayerStats() {
    const daysLeft = Math.max(40 - currentDay, 0);
    const completionPercentage = Math.round((currentDay / 40) * 100);
    const totalPeople = users.length;

    document.getElementById('daysPassed').textContent = currentDay;
    document.getElementById('daysLeft').textContent = daysLeft;
    document.getElementById('completionPercentage').textContent = `${completionPercentage}%`;
    document.getElementById('totalPeople').textContent = totalPeople;
}

function getHebrewDate() {
    const now = new Date();
    const options = { year: 'numeric', month: 'long', day: 'numeric', calendar: 'hebrew' };
    return new Intl.DateTimeFormat('he-IL', options).format(now);
}

function getGregorianDate() {
    const now = new Date();
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return new Intl.DateTimeFormat('he-IL', options).format(now);
}

function updateDates() {
    document.getElementById('hebrewDate').textContent = getHebrewDate();
    document.getElementById('gregorianDate').textContent = getGregorianDate();
}

updatePrayerStatus();
displayAllPrayers();

function requestPermission() {
    Notification.requestPermission().then((permission) => {
        if (permission === 'granted') {
            console.log('Notification permission granted.');
            getToken();
        } else {
            console.log('Unable to get permission to notify.');
        }
    });
}

function getToken() {
    messaging.getToken().then((currentToken) => {
        if (currentToken) {
            console.log('FCM Token:', currentToken);
            saveTokenToDatabase(currentToken);
        } else {
            console.log('No registration token available. Request permission to generate one.');
            requestPermission();
        }
    }).catch((err) => {
        console.log('An error occurred while retrieving token. ', err);
    });
}

function saveTokenToDatabase(token) {
    const user = nameSelect.value;
    if (user) {
        db.ref('users/' + user + '/fcmToken').set(token)
        .then(() => {
            console.log('Token saved to database');
        })
        .catch((error) => {
            console.error('Error saving token:', error);
        });
    }
}

messaging.onMessage((payload) => {
    console.log('Message received. ', payload);
    const notificationTitle = payload.notification.title;
    const notificationOptions = {
        body: payload.notification.body,
        icon: '/path/to/icon.png'
    };

    new Notification(notificationTitle, notificationOptions);
});

document.getElementById('requestNotifications').addEventListener('click', requestPermission);

// קוד לקבלת מזהה ה-FCM
function getToken() {
    messaging.getToken()
    .then((currentToken) => {
        if (currentToken) {
            console.log('FCM Token:', currentToken);
            // שמירה של ה-token ב-Firebase Database או בשרת שלך
            saveTokenToDatabase(currentToken);
        } else {
            console.log('No registration token available. Request permission to generate one.');
            // בקשה לאישור התראות אם ה-token לא זמין
            requestPermission();
        }
    })
    .catch((err) => {
        console.error('An error occurred while retrieving token. ', err);
    });
}

// קריאה לפונקציה לקבלת ה-token
getToken();


</script>
</body>
</html>
